<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üåç Malawi Groundwater Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --primary: #005aa7;
      --primary-light: #0082c8;
      --secondary: #00a86b;
      --accent: #ff9800;
      --lighter: #e6f2ff;
      --dark: #003366;
      --border: #c0d8f0;
      --danger: #ff4b5c;
    }
    html,body{margin:0;height:100%;font-family:'Segoe UI',sans-serif;background:#f0f7ff;}
    #topbar{position:fixed;top:0;left:0;right:0;height:60px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1200;font-weight:600;font-size:20px}
    #container{display:flex;margin-top:60px;height:calc(100vh - 60px);}
    #map{flex:1;height:100%;}
    #sidebar{width:440px;display:flex;flex-direction:row;background:#fff;border-right:1px solid var(--border);}
    .tabs-container{width:150px;background:var(--lighter);display:flex;flex-direction:column;}
    .tab{padding:15px;text-align:center;margin:4px;cursor:pointer;border-radius:8px;background:#d9e9ff;font-weight:600}
    .tab.active{background:linear-gradient(180deg,var(--primary-light),var(--primary));color:#fff}
    .tab-content-container{flex:1;overflow-y:auto;padding:15px;}
    .tabContent{display:none;}
    select,input,button{width:100%;margin:8px 0;padding:8px;border:1px solid var(--border);border-radius:6px}
    button{background:linear-gradient(180deg,var(--primary-light),var(--primary));color:#fff;font-weight:600;cursor:pointer}
  </style>
</head>
<body>
  <div id="topbar">
    <div>üåç Malawi Groundwater Dashboard</div>
    <div><span style="font-size:14px;">Total Yield:</span> <strong id="totalYield" style="color:yellow">0</strong> m¬≥</div>
  </div>

  <div id="container">
    <div id="sidebar">
      <div class="tabs-container">
        <div class="tab active" data-tab="borehole">üíß Borehole</div>
        <div class="tab" data-tab="monitor">üìä Monitoring</div>
        <div class="tab" data-tab="aquifer">ü™® Aquifers</div>
        <div class="tab" data-tab="geology">üåã Geology</div>
        <div class="tab" data-tab="faults">‚ö° Faults</div>
      </div>

      <div class="tab-content-container">
        <!-- Borehole -->
        <div id="boreholecontent" class="tabContent" style="display:block">
          <h3>Boreholes</h3>
          <input id="boreholeCSV" type="file" accept=".csv">
          <div id="boreholeSummary">Upload borehole CSV to view data.</div>
          <button id="toggleHeatmap">Toggle Heatmap</button>
          <button id="downloadBoreholeData">‚¨áÔ∏è Download Borehole Data</button>
        </div>

        <!-- Monitoring -->
        <div id="monitorcontent" class="tabContent">
          <h3>Monitoring Wells</h3>
          <input id="monitorCSV" type="file" accept=".csv">
          <select id="stationSelect"></select>
          <select id="chartType">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
          </select>
          <div id="monitorChart" style="height:300px"></div>
        </div>

        <!-- Aquifers -->
        <div id="aquifercontent" class="tabContent">
          <h3>Aquifer Map</h3>
          <select id="aquiferClass">
            <option value="all">All</option>
            <option value="Basement Rock">Basement Rock</option>
            <option value="Alluvial Sediment">Alluvial Sediment</option>
            <option value="Weathered Basement">Weathered Basement</option>
          </select>
        </div>

        <!-- Geology -->
        <div id="geologycontent" class="tabContent">
          <h3>Geological Map</h3>
          <select id="geoCategory">
            <option value="all">All</option>
            <option value="Lake">Lake</option>
            <option value="Metamorphic Rocks">Metamorphic Rocks</option>
            <option value="Magmatic Intrusions">Magmatic Intrusions</option>
            <option value="Sedimentary Rocks">Sedimentary Rocks</option>
            <option value="Sediments">Sediments</option>
          </select>
        </div>

        <!-- Faults -->
        <div id="faultscontent" class="tabContent">
          <h3>Fault Map</h3>
          <p>Fault lines displayed with attributes.</p>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>

<script>
/* ==== Base Maps ==== */
const baseLayers = {
  "OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM contributors'}),
  "Google Hybrid": L.tileLayer('http://mt0.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'Google'})
};
const map=L.map('map',{center:[-13.9,33.8],zoom:7,layers:[baseLayers["OSM"]]});
L.control.layers(baseLayers).addTo(map);

/* ==== Tabs ==== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tabContent").forEach(c=>c.style.display="none");
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab+"content").style.display="block";
  });
});

/* ==== Aquifers ==== */
let aquiferLayer=L.layerGroup().addTo(map);
fetch("data/Aquifer.geojson").then(r=>r.json()).then(geojson=>{
  aquiferLayer=L.geoJSON(geojson,{
    style:f=>{
      let c="#999";
      if(f.properties.AQ_Class==="Basement Rock")c="#1f78b4";
      if(f.properties.AQ_Class==="Alluvial Sediment")c="#33a02c";
      if(f.properties.AQ_Class==="Weathered Basement")c="#ff7f00";
      return{color:c,fillOpacity:0.5};
    },
    onEachFeature:(f,l)=>l.bindPopup(`Aquifer: ${f.properties.AQ_Class}`)
  }).addTo(map);
});
document.getElementById("aquiferClass").addEventListener("change",e=>{
  const val=e.target.value;
  aquiferLayer.eachLayer(l=>{
    const aq=l.feature.properties.AQ_Class;
    l.setStyle({fillOpacity:(val==="all"||aq===val)?0.5:0});
  });
});

/* ==== Geology ==== */
let geologyLayer=L.layerGroup().addTo(map);
fetch("data/Geological.geojson").then(r=>r.json()).then(geojson=>{
  geologyLayer=L.geoJSON(geojson,{
    style:f=>{
      let c="#ccc";
      if(f.properties.Category==="Lake")c="#1f78b4";
      if(f.properties.Category==="Metamorphic Rocks")c="#6a3d9a";
      if(f.properties.Category==="Magmatic Intrusions")c="#e31a1c";
      if(f.properties.Category==="Sedimentary Rocks")c="#ff7f00";
      if(f.properties.Category==="Sediments")c="#33a02c";
      return{color:c,fillOpacity:0.6};
    },
    onEachFeature:(f,l)=>l.bindPopup(`Geology: ${f.properties.Category}`)
  }).addTo(map);
});
document.getElementById("geoCategory").addEventListener("change",e=>{
  const val=e.target.value;
  geologyLayer.eachLayer(l=>{
    const cat=l.feature.properties.Category;
    l.setStyle({fillOpacity:(val==="all"||cat===val)?0.6:0});
  });
});

/* ==== Faults ==== */
let faultsLayer=L.layerGroup().addTo(map);
fetch("data/faults.geojson").then(r=>r.json()).then(geojson=>{
  faultsLayer=L.geoJSON(geojson,{
    style:{color:"#000",weight:2,dashArray:"5,5"},
    onEachFeature:(f,l)=>l.bindPopup(`Fault: ${f.properties.Name||"N/A"}`)
  }).addTo(map);
});
</script>
</body>
</html>
