<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üåç Malawi Groundwater Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    :root {
      --primary: #005aa7;
      --primary-light: #0082c8;
      --secondary: #00a86b;
      --accent: #ff9800;
      --lighter: #e6f2ff;
      --dark: #003366;
      --border: #c0d8f0;
      --danger: #ff4b5c;
    }
    html,body{margin:0;height:100%;font-family:'Segoe UI',sans-serif;background:#f0f7ff;}
    #topbar{position:fixed;top:0;left:0;right:0;height:60px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1200;font-weight:600;font-size:20px}
    #container{display:flex;margin-top:60px;height:calc(100vh - 60px);}
    #map{flex:1;height:100%;}
    #sidebar{width:440px;display:flex;flex-direction:row;background:#fff;border-right:1px solid var(--border);}
    .tabs-container{width:150px;background:var(--lighter);display:flex;flex-direction:column;}
    .tab{padding:15px;text-align:center;margin:4px;cursor:pointer;border-radius:8px;background:#d9e9ff;font-weight:600}
    .tab.active{background:linear-gradient(180deg,var(--primary-light),var(--primary));color:#fff}
    .tab-content-container{flex:1;overflow-y:auto;padding:15px;}
    .tabContent{display:none;}
    select,input,button{width:100%;margin:8px 0;padding:8px;border:1px solid var(--border);border-radius:6px}
    button{background:linear-gradient(180deg,var(--primary-light),var(--primary));color:#fff;font-weight:600;cursor:pointer}
    .summary{font-size:12px;color:#555;margin-top:5px;}
    .layerToggle{margin-bottom:10px;}
    .legend{background:white;padding:8px;border-radius:6px;font-size:12px;line-height:18px;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
    .legend div{margin-bottom:4px;}
    .legend span{display:inline-block;width:16px;height:16px;margin-right:6px;vertical-align:middle;}
  </style>
</head>
<body>
  <div id="topbar">
    <div>üåç Malawi Groundwater Dashboard</div>
    <div style="display:flex;align-items:center;gap:15px;">
      <div>
        <span style="font-size:14px;">Total Yield:</span> 
        <strong id="totalYield" style="color:yellow">0</strong> m¬≥
      </div>
      <img src="https://raw.githubusercontent.com/naturalwaterresourcesauthority-del/dashboard/main/nwra_logo.png" alt="NWRA Logo" style="height:45px;width:auto;background-color: white;">
    </div>
  </div>

  <div id="container">
    <div id="sidebar">
      <div class="tabs-container">
        <div class="tab active" data-tab="borehole">üíß Borehole</div>
        <div class="tab" data-tab="monitor">üìä Monitoring</div>
        <div class="tab" data-tab="aquifer">ü™® Aquifers</div>
        <div class="tab" data-tab="geology">üåã Geology</div>
        <div class="tab" data-tab="faults">‚ö° Faults</div>
        <div class="tab" data-tab="rivers">üåä Rivers</div>
      </div>

      <div class="tab-content-container">
        <!-- Borehole -->
        <div id="boreholecontent" class="tabContent" style="display:block">
          <h3>Boreholes</h3>
          <input id="boreholeCSV" type="file" accept=".csv">
          <div id="boreholeSummary">Upload borehole CSV to view data.</div>
          <button id="toggleHeatmap">Toggle Heatmap</button>
          <button id="downloadBoreholeData">‚¨áÔ∏è Download Borehole Data</button>
        </div>

        <!-- Monitoring -->
        <div id="monitorcontent" class="tabContent">
          <h3>Monitoring Wells</h3>
          <input id="monitorCSV" type="file" accept=".csv">
          <select id="stationSelect"></select>
          <select id="chartType">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
          </select>
          <div id="monitorChart" style="height:300px"></div>
        </div>

        <!-- Aquifers -->
        <div id="aquifercontent" class="tabContent">
          <h3>Aquifer Map</h3>
          <div class="layerToggle"><label><input type="checkbox" id="toggleAquifers" checked> Show Aquifers</label></div>
          <label><input type="checkbox" class="aquiferFilter" value="Basement Rock" checked> Basement Rock</label><br>
          <label><input type="checkbox" class="aquiferFilter" value="Alluvial Sediment" checked> Alluvial Sediment</label><br>
          <label><input type="checkbox" class="aquiferFilter" value="Weathered Basement" checked> Weathered Basement</label><br>
          <div class="summary" id="aquiferSummary">3 categories visible</div>
          <button id="downloadAquifer">‚¨áÔ∏è Download Filtered Aquifers</button>
        </div>

        <!-- Geology -->
        <div id="geologycontent" class="tabContent">
          <h3>Geological Map</h3>
          <div class="layerToggle"><label><input type="checkbox" id="toggleGeology" checked> Show Geology</label></div>
          <label><input type="checkbox" class="geoFilter" value="Lake" checked> Lake</label><br>
          <label><input type="checkbox" class="geoFilter" value="Metamorphic Rocks" checked> Metamorphic Rocks</label><br>
          <label><input type="checkbox" class="geoFilter" value="Magmatic Intrusions" checked> Magmatic Intrusions</label><br>
          <label><input type="checkbox" class="geoFilter" value="Sedimentary Rocks" checked> Sedimentary Rocks</label><br>
          <label><input type="checkbox" class="geoFilter" value="Sediments" checked> Sediments</label><br>
          <div class="summary" id="geoSummary">5 categories visible</div>
          <button id="downloadGeology">‚¨áÔ∏è Download Filtered Geology</button>
        </div>

        <!-- Faults -->
        <div id="faultscontent" class="tabContent">
          <h3>Fault Map</h3>
          <div class="layerToggle"><label><input type="checkbox" id="toggleFaults" checked> Show Faults</label></div>
          <p>Fault lines displayed with attributes.</p>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>

<script>
/* ==== Base Maps ==== */
const baseLayers = {
  "OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM contributors'}),
  "Google Hybrid": L.tileLayer('http://mt0.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'Google'})
};
const map = L.map('map',{center:[-13.9,33.8],zoom:7,layers:[baseLayers["OSM"]]} );
L.control.layers(baseLayers).addTo(map);

/* ==== Search restricted to Malawi ==== */
L.Control.geocoder({
  defaultMarkGeocode: true,
  geocoder: L.Control.Geocoder.nominatim({
    geocodingQueryParams: { countrycodes: 'MW' }
  })
}).addTo(map);

/* ==== Tabs ==== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tabContent").forEach(c=>c.style.display="none");
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab+"content").style.display="block";
  });
});

/* ==== Legends ==== */
const legendControl = L.control({position:"bottomright"});
legendControl.onAdd = function(map){
  this._div = L.DomUtil.create("div","legend");
  this.update();
  return this._div;
};
legendControl.update = function(content=""){ this._div.innerHTML = content; };
legendControl.addTo(map);

function showLegend(type){
  let html = "<b>"+type+" Legend</b><br>";
  if(type==="Aquifers"){
    html += '<div><span style="background:#1f78b4"></span> Basement Rock</div>';
    html += '<div><span style="background:#33a02c"></span> Alluvial Sediment</div>';
    html += '<div><span style="background:#ff7f00"></span> Weathered Basement</div>';
  } else if(type==="Geology"){
    html += '<div><span style="background:#1f78b4"></span> Lake</div>';
    html += '<div><span style="background:#6a3d9a"></span> Metamorphic Rocks</div>';
    html += '<div><span style="background:#e31a1c"></span> Magmatic Intrusions</div>';
    html += '<div><span style="background:#ff7f00"></span> Sedimentary Rocks</div>';
    html += '<div><span style="background:#33a02c"></span> Sediments</div>';
  } else if(type==="Faults"){
    html += '<div><span style="background:#000;border:1px dashed #000;width:20px;height:2px;display:inline-block;margin-right:6px;"></span> Faults</div>';
  }
  legendControl.update(html);
}
function clearLegend(){ legendControl.update(""); }

/* ==== Aquifers ==== */
let aquiferLayer;
fetch("https://raw.githubusercontent.com/naturalwaterresourcesauthority-del/dashboard/main/aquifer.geojson")
  .then(r=>r.json()).then(geojson=>{
    aquiferLayer = L.geoJSON(geojson,{
      style:f=>{
        let c="#999";
        if(f.properties.AQ_Class==="Basement Rock")c="#1f78b4";
        if(f.properties.AQ_Class==="Alluvial Sediment")c="#33a02c";
        if(f.properties.AQ_Class==="Weathered Basement")c="#ff7f00";
        return{color:c,weight:0.7,fillOpacity:0.5};
      },
      onEachFeature:(f,l)=>{
        l.bindPopup(`Aquifer: ${f.properties.AQ_Class}`);
        l.on("mouseover",()=>l.setStyle({weight:2}));
        l.on("mouseout",()=>l.setStyle({weight:0.7}));
      }
    }).addTo(map);
    showLegend("Aquifers");
  });

function updateAquifers(){
  const selected = Array.from(document.querySelectorAll(".aquiferFilter:checked")).map(x=>x.value);
  aquiferLayer.eachLayer(l=>{
    const aq = l.feature.properties.AQ_Class;
    l.setStyle({fillOpacity: selected.includes(aq)?0.5:0});
  });
  document.getElementById("aquiferSummary").innerText = `${selected.length} categories visible`;
}
document.querySelectorAll(".aquiferFilter").forEach(cb=>cb.addEventListener("change",updateAquifers));
document.getElementById("toggleAquifers").addEventListener("change",e=>{
  if(e.target.checked){ map.addLayer(aquiferLayer); showLegend("Aquifers"); }
  else{ map.removeLayer(aquiferLayer); clearLegend(); }
});

/* ==== Geology ==== */
let geologyLayer;
fetch("https://raw.githubusercontent.com/naturalwaterresourcesauthority-del/dashboard/main/geology.geojson")
  .then(r=>r.json()).then(geojson=>{
    geologyLayer = L.geoJSON(geojson,{
      style:f=>{
        let c="#ccc";
        if(f.properties.Category==="Lake")c="#1f78b4";
        if(f.properties.Category==="Metamorphic Rocks")c="#6a3d9a";
        if(f.properties.Category==="Magmatic Intrusions")c="#e31a1c";
        if(f.properties.Category==="Sedimentary Rocks")c="#ff7f00";
        if(f.properties.Category==="Sediments")c="#33a02c";
        return{color:c,weight:0.7,fillOpacity:0.6};
      },
      onEachFeature:(f,l)=>{
        l.bindPopup(`Geology: ${f.properties.Category}`);
        l.on("mouseover",()=>l.setStyle({weight:2}));
        l.on("mouseout",()=>l.setStyle({weight:0.7}));
      }
    }).addTo(map);
  });

function updateGeology(){
  const selected = Array.from(document.querySelectorAll(".geoFilter:checked")).map(x=>x.value);
  geologyLayer.eachLayer(l=>{
    const cat = l.feature.properties.Category;
    l.setStyle({fillOpacity: selected.includes(cat)?0.6:0});
  });
  document.getElementById("geoSummary").innerText = `${selected.length} categories visible`;
}
document.querySelectorAll(".geoFilter").forEach(cb=>cb.addEventListener("change",updateGeology));
document.getElementById("toggleGeology").addEventListener("change",e=>{
  if(e.target.checked){ map.addLayer(geologyLayer); showLegend("Geology"); }
  else{ map.removeLayer(geologyLayer); clearLegend(); }
});

/* ==== Faults ==== */
let faultsLayer;
fetch("https://raw.githubusercontent.com/naturalwaterresourcesauthority-del/dashboard/main/faults.geojson")
  .then(r=>r.json()).then(geojson=>{
    faultsLayer = L.geoJSON(geojson,{
      style:{color:"#000",weight:0.7,dashArray:"5,5"},
      onEachFeature:(f,l)=>l.bindPopup(`Fault: ${f.properties.Name||"N/A"}`)
    }).addTo(map);
  });
document.getElementById("toggleFaults").addEventListener("change",e=>{
  if(e.target.checked){ map.addLayer(faultsLayer); showLegend("Faults"); }
  else{ map.removeLayer(faultsLayer); clearLegend(); }
});

/* ==== Download Functions ==== */
function downloadJSON(data, filename){
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  a.click(); URL.revokeObjectURL(url);
}
document.getElementById("downloadAquifer").addEventListener("click",()=>{
  const selected = Array.from(document.querySelectorAll(".aquiferFilter:checked")).map(x=>x.value);
  const features = [];
  aquiferLayer.eachLayer(l=>{
    if(selected.includes(l.feature.properties.AQ_Class)) features.push(l.feature);
  });
  downloadJSON({type:"FeatureCollection",features}, "filtered_aquifers.geojson");
});
document.getElementById("downloadGeology").addEventListener("click",()=>{
  const selected = Array.from(document.querySelectorAll(".geoFilter:checked")).map(x=>x.value);
  const features = [];
  geologyLayer.eachLayer(l=>{
    if(selected.includes(l.feature.properties.Category)) features.push(l.feature);
  });
  downloadJSON({type:"FeatureCollection",features}, "filtered_geology.geojson");
});
</script>
</body>
</html>
